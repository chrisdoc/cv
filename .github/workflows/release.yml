name: Build and release Typst document

on:
  push:
    # Build on main and on any tag push (tag builds are used for releases).
    branches:
      - main
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Typst
        uses: lvignoli/typst-action@main
        with:
          source_file: cv.typ

      # typst-action outputs a PDF named after the source file; rename it to the
      # desired public filename for repository links and release assets.
      - name: Rename PDF
        run: mv cv.pdf CV_Christoph_Kieslich.pdf

      - name: Upload PDF file
        uses: actions/upload-artifact@v5
        with:
          name: PDF
          path: CV_Christoph_Kieslich.pdf

      # Keep the latest generated PDF committed on main so the README link to
      # the file in the repository root always stays up to date.
      - name: Commit updated PDF to main
        uses: EndBug/add-and-commit@v9
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          add: CV_Christoph_Kieslich.pdf

      # When a pull request is merged into main (or any direct push to main),
      # automatically create a new version tag so a release is published for
      # that change.
      - name: Create release tag on main pushes
        if: >-
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main' &&
          github.actor != 'github-actions[bot]'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --tags --force

          # Find the latest semantic version tag (vMAJOR.MINOR.PATCH).
          latest_tag=$(git tag --list 'v*.*.*' | sort -V | tail -n 1)

          if [ -z "${latest_tag}" ]; then
            # Default to v1.0.0 if no prior semver-style tags exist.
            next_tag="v1.0.0"
          else
            version="${latest_tag#v}"
            IFS='.' read -r major minor patch <<< "${version}"
            patch=$((patch + 1))
            next_tag="v${major}.${minor}.${patch}"
          fi

          echo "Creating release tag ${next_tag} for $(git rev-parse --short HEAD)"
          git tag "${next_tag}"
          git push origin "${next_tag}"

          # Expose the tag so a later step in this job can publish the release
          # without relying on the tag push to trigger a new workflow run
          # (pushes made with GITHUB_TOKEN do not start workflows).
          echo "NEXT_RELEASE_TAG=${next_tag}" >> "$GITHUB_ENV"

      - name: Get current date
        id: date
        run: echo "DATE=$(date +%Y-%m-%d-%H:%M)" >> $GITHUB_ENV

      # Create a GitHub release for auto-tagged pushes to main in the same
      # workflow run that created the tag.
      - name: Release for main pushes
        uses: softprops/action-gh-release@v2
        if: >-
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main' &&
          env.NEXT_RELEASE_TAG != ''
        with:
          tag_name: ${{ env.NEXT_RELEASE_TAG }}
          name: "${{ env.NEXT_RELEASE_TAG }} — ${{ env.DATE }}"
          files: CV_Christoph_Kieslich.pdf

      # Create a GitHub release (with the built PDF attached) when tags are
      # pushed manually. This keeps support for "git push --tags" flows.
      - name: Release for tag pushes
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ github.ref_name }} — ${{ env.DATE }}"
          files: CV_Christoph_Kieslich.pdf
